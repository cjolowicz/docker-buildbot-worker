PLATFORM = $(notdir $(abspath $(CURDIR)/..))
RELEASE = $(notdir $(CURDIR))

ifeq ($(strip $(REPO)),)
    IMAGE = buildbot-worker:1.8.0-$(PLATFORM)-$(RELEASE)-$(ARCH)
else
    IMAGE = $(REPO)/buildbot-worker:1.8.0-$(PLATFORM)-$(RELEASE)-$(ARCH)
endif

all: build

build: Dockerfile.m4
	m4 -I $(TOPDIR)/m4 -P -D ARCH=$(ARCH) -D REPO=$(REPO) Dockerfile.m4 | \
	    docker build -f - -t $(IMAGE) $(TOPDIR)

push: build
	docker push $(IMAGE)

.PHONY: all build push
